---
layout:     post
title:      FLEX使用教程
subtitle:   Nvidia 位置动力学模拟工具
date:       2020-02-29
author:     infinityyf
header-img: img/nvidia.jpg
catalog: true
tags:
    - FLEX
    - PBD
---
# Flex library  
所有粒子和约束以flat-array的形式一次同时传入解算器，使用**SOA**数据布局。  
_**SOA**是什么？_
```C
struct {
    uint8_t r, g, b;
} AoS[N];

struct {
    uint8_t r[N];
    uint8_t g[N];
    uint8_t b[N];
} SoA;
```
## nvflex.h
 对粒子列表的操作和约束
## nvflexext.h
 基础物体管理，便于整合
# Code Demo  

```C
#include <NvFlex.h>
NvFlexLibrary* library = NvFlexInit();
NvFlexSolver* solver = NvFlexCreateSolver(library);

// param2:element count
// param3:stride
NvFlexBuffer* particleBuffer = NvlexAllocBuffer(library, n, sizeof(Vec4), eNvFlexBufferHost);

while(true){
    // map buffers for reading / writing
    // get the address whitch can be accessed by CPU
    // this call will be blocked until other transfers
    float4* particles = (float4*)NvlexMap(particles, eNvFlexMapWait);

    // spawn (user method)
    SpawnParticles(particles, velocities, phases);

    // render (user method)
    RenderParticles(particles, velocities, phases);

    // unmap buffers,after CPU has finished writing buffers
    NvFlexUnmap(particleBuffer);

    // write to device (async) 
    NvFlexSetParticles(particleBuffer, n);

    // tick update the solver
    NvFlexUpdateSolver(solver, dt, 1, false);

    // read back (async) retreve data from FLEX
    NvFlexGetParticles(particleBuffer, n);
}
NvFlexFreeBuffer(particleBuffer);
NvFlexDestroySolver(solver);
NvFlexShutdown(library);
```
  
# Particles
通过位置、速度、质量以及所处阶段来对粒子进行描述。**质量存储为质量的倒数，并和位置存储在一起**`[x, y, z, 1/m]`。  
## spawn particles
```c
for (int i=0; i < n; ++i)
{
        particles[i] = RandomSpawnPosition();
        velocities[i] = RandomSpawnVelocity();
        phases[i] = NvFlexMakePhase(0, eNvFlexPhaseSelfCollide);
}
```
对数据进行初始化需要按照下图所示的过程：
![alt](../img/FLEX/spawn_particles.png)  
## Radius  
使用`NvFlexParams::rasius`进行设置。




